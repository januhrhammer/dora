# Medicine Tracker - Grandma's Medicine Management System

A simple, private web application to track medicine inventory and send automated reminders for grandma's medicine management.

## Features

- üíä **Flexible medicine tracking** with dosage information
  - Support for daily schedules with morning/evening timing
  - Support for weekly alternating schedules (e.g., different dosages on even/odd weeks)
  - Track dosage strength (e.g., 75¬µg, 100mg)
- üì¶ Monitor package sizes and current stock levels
- ‚è∞ **Automated email reminders**:
  - Weekly setup reminder (every Sunday at 9:00 AM)
  - Reorder reminder when less than 3 weeks of pills remain
  - Quarterly insurance card reminder (tracks refill dates automatically)
- üìä Visual dashboard showing remaining days/weeks for each medicine
- ‚úèÔ∏è Easy drug plan management (add, edit, delete, refill)
- üîÑ **Database migrations** with Alembic (update schema without losing data)
- üíæ **Persistent data** stored in Docker volumes (survives container restarts)
- üîí Private and secure - runs on your own server

## Technology Stack

- **Backend**: FastAPI (Python)
- **Frontend**: Svelte
- **Database**: SQLite with Alembic migrations
- **Deployment**: Docker + Docker Compose with persistent volumes
- **CI/CD**: GitHub Actions

---

## üìñ Project Structure

```
Tabletten/
‚îú‚îÄ‚îÄ backend/                 # FastAPI backend
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py         # Main FastAPI application & routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py     # Database connection & session
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py       # SQLAlchemy ORM models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.py      # Pydantic validation schemas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crud.py         # Database CRUD operations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email_service.py # Email reminder service
‚îÇ   ‚îú‚îÄ‚îÄ alembic/            # Database migrations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ versions/       # Migration version files
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt    # Python dependencies
‚îÇ   ‚îú‚îÄ‚îÄ MIGRATIONS.md       # Database migration guide
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile          # Backend Docker image
‚îú‚îÄ‚îÄ frontend/               # Svelte frontend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.svelte      # Main UI component
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.js         # Entry point
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ api.js      # API client
‚îÇ   ‚îú‚îÄ‚îÄ package.json        # Node dependencies
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile          # Frontend Docker image
‚îú‚îÄ‚îÄ docker-compose.yml      # Orchestrates both services
‚îî‚îÄ‚îÄ .github/
    ‚îî‚îÄ‚îÄ workflows/
        ‚îî‚îÄ‚îÄ deploy.yml      # CI/CD workflow
```

---

## üöÄ Quick Start (Local Development)

### Prerequisites

- Python 3.11+
- Node.js 20+
- npm or yarn

### 1. Backend Setup

```bash
cd backend

# Create virtual environment
python -m venv venv

# Activate virtual environment
# On Windows:
venv\Scripts\activate
# On macOS/Linux:
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Run database migrations (creates/updates database schema)
alembic upgrade head

# Create .env file for email configuration
cp .env.example .env
# Edit .env with your email settings

# Run the backend
uvicorn app.main:app --reload
```

The API will be available at http://localhost:8000

API documentation (automatically generated by FastAPI):
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### 2. Frontend Setup

```bash
cd frontend

# Install dependencies
npm install

# Run development server
npm run dev
```

The frontend will be available at http://localhost:5173

---

## üóÑÔ∏è Database Migrations with Alembic

This project uses **Alembic** for database schema management. This means you can update the database structure without losing data!

### Why Alembic?

- ‚úÖ **Preserves data** when changing database schema
- ‚úÖ **Version controlled** - all schema changes tracked in git
- ‚úÖ **Rollback capability** - can undo migrations if needed
- ‚úÖ **Automatic on Docker startup** - migrations run automatically

### Making Schema Changes

When you modify `backend/app/models.py`, create a migration:

```bash
cd backend

# Generate migration file (Alembic auto-detects changes)
alembic revision --autogenerate -m "Description of changes"

# Review the generated file in alembic/versions/

# Apply the migration
alembic upgrade head
```

### Common Commands

```bash
# Check current migration status
alembic current

# View migration history
alembic history

# Rollback one migration
alembic downgrade -1

# Upgrade to latest
alembic upgrade head
```

### Docker Automatic Migrations

When running with Docker Compose, migrations are **automatically applied** on container startup! No manual intervention needed.

üìö **For detailed migration guide, see:** `backend/MIGRATIONS.md`

---

## üê≥ Docker Deployment (Production)

### Prerequisites

- Docker
- Docker Compose

### 1. Configure Environment Variables

```bash
# Copy the example file
cp .env.example .env

# Edit .env with your email settings
nano .env
```

**Email Configuration (using Mailjet)**:
1. Sign up for free at [Mailjet](https://www.mailjet.com/)
2. Verify your sender email address in Mailjet (Account Settings > Sender Addresses)
3. Get your API keys from [Mailjet API Keys](https://app.mailjet.com/account/apikeys)
4. Add the credentials to your `.env` file

```env
MAILJET_API_KEY=your_api_key_here
MAILJET_API_SECRET=your_api_secret_here
FROM_EMAIL=your-verified-sender@example.com
FROM_NAME=Medicine Tracker
TO_EMAIL=recipient@example.com
TO_NAME=Grandma
```

### 2. Build and Run

```bash
# Build and start both containers
docker-compose up -d --build

# View logs
docker-compose logs -f

# Stop containers
docker-compose down
```

The app will be available at http://localhost (port 80)

---

## üåê VPS Deployment with GitHub CI/CD

This guide walks you through deploying to a VPS (Virtual Private Server) with automatic updates from GitHub.

### Step 1: Get a VPS

Popular providers:
- **DigitalOcean** (Droplets starting at $6/month)
- **Linode** (starting at $5/month)
- **Vultr** (starting at $5/month)
- **Hetzner** (starting at ‚Ç¨4/month)

Recommended specs:
- 1 CPU
- 1-2 GB RAM
- 25 GB SSD
- Ubuntu 22.04 LTS

### Step 2: Initial VPS Setup

SSH into your VPS:

```bash
ssh root@your-vps-ip
```

Update the system:

```bash
apt update && apt upgrade -y
```

Install Docker and Docker Compose:

```bash
# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Install Docker Compose
apt install docker-compose -y

# Verify installations
docker --version
docker-compose --version
```

Install Git:

```bash
apt install git -y
```

### Step 3: Clone Your Repository

```bash
# Clone the repository
cd ~
git clone https://github.com/your-username/medicine-tracker.git

# Navigate to the project
cd medicine-tracker

# Create .env file
cp .env.example .env
nano .env  # Fill in your email settings
```

### Step 4: Configure GitHub Secrets

Go to your GitHub repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions

Add the following secrets:

1. **VPS_HOST**: Your VPS IP address (e.g., `203.0.113.42`)
2. **VPS_USERNAME**: SSH username (usually `root` or create a dedicated user)
3. **VPS_SSH_KEY**: Your private SSH key

To generate and add SSH key:

```bash
# On your local machine
ssh-keygen -t ed25519 -C "github-actions"

# Copy the private key (this goes into VPS_SSH_KEY secret)
cat ~/.ssh/id_ed25519

# Copy the public key to your VPS
ssh-copy-id -i ~/.ssh/id_ed25519.pub root@your-vps-ip
```

### Step 5: First Deployment

On your VPS:

```bash
cd ~/medicine-tracker
docker-compose up -d --build
```

Verify it's running:

```bash
docker-compose ps
curl localhost
```

### Step 6: Configure Domain (Optional but Recommended)

If you have a domain from Porkbun:

#### A. Add DNS Record in Porkbun

1. Log in to Porkbun
2. Go to your domain's DNS settings
3. Add an A record:
   - Type: `A`
   - Host: `medicine` (or subdomain of your choice)
   - Answer: Your VPS IP address
   - TTL: 600

Wait a few minutes for DNS propagation.

#### B. Install and Configure Nginx with SSL

On your VPS:

```bash
# Install Nginx and Certbot
apt install nginx certbot python3-certbot-nginx -y

# Create Nginx config
nano /etc/nginx/sites-available/medicine-tracker
```

Add this configuration:

```nginx
server {
    listen 80;
    server_name medicine.yourdomain.com;

    location / {
        proxy_pass http://localhost:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Enable the site and get SSL certificate:

```bash
# Enable the site
ln -s /etc/nginx/sites-available/medicine-tracker /etc/nginx/sites-enabled/

# Test configuration
nginx -t

# Reload Nginx
systemctl reload nginx

# Get SSL certificate (follow prompts)
certbot --nginx -d medicine.yourdomain.com
```

Now your app will be accessible at https://medicine.yourdomain.com with automatic SSL!

### Step 7: Automatic Deployment

Now, whenever you push to the `main` branch on GitHub:

1. GitHub Actions will trigger
2. It will SSH into your VPS
3. Pull the latest code
4. Rebuild and restart the Docker containers

Test it:

```bash
# On your local machine
git add .
git commit -m "Test deployment"
git push origin main
```

Check the Actions tab on GitHub to see the deployment progress.

---

## üìß Email Configuration Details

This application uses **Mailjet** for reliable transactional email delivery. Mailjet is free for up to 6,000 emails/month (200/day), which is more than enough for this application.

### Why Mailjet?

- ‚úÖ **More reliable** than direct SMTP for automated emails
- ‚úÖ **Better deliverability** - emails less likely to go to spam
- ‚úÖ **Free tier** - 6,000 emails/month
- ‚úÖ **Easy to set up** - just API keys, no complex SMTP configuration
- ‚úÖ **Email tracking** - see delivery status in Mailjet dashboard

### Setting up Mailjet

#### Step 1: Create a Mailjet Account

1. Go to [https://www.mailjet.com/](https://www.mailjet.com/)
2. Click "Sign Up" and create a free account
3. Verify your email address

#### Step 2: Verify Your Sender Email

**Important:** You must verify the email address you want to send from.

1. Log in to Mailjet
2. Go to **Account Settings** > **Sender Addresses & Domains**
3. Click **Add a Sender Address**
4. Enter your email address (e.g., `your-email@gmail.com`)
5. Check your email for the verification link
6. Click the link to verify

#### Step 3: Get Your API Keys

1. Go to [https://app.mailjet.com/account/apikeys](https://app.mailjet.com/account/apikeys)
2. You'll see your **API Key** and **Secret Key**
3. Copy both keys (you'll need them for your `.env` file)

#### Step 4: Configure Your Application

Add the following to your `.env` file:

```env
MAILJET_API_KEY=your_api_key_here
MAILJET_API_SECRET=your_secret_key_here
FROM_EMAIL=your-verified-email@example.com
FROM_NAME=Medicine Tracker
TO_EMAIL=recipient@example.com
TO_NAME=Grandma
```

**Important Notes:**
- `FROM_EMAIL` must be the email you verified in Step 2
- `TO_EMAIL` is where the reminders will be sent (can be any email)
- `FROM_NAME` and `TO_NAME` are optional display names

### Testing Email

Use the "Test Email" button in the web interface to verify your Mailjet configuration.

You can also check the **Mailjet Dashboard** ([https://app.mailjet.com/stats](https://app.mailjet.com/stats)) to see:
- Email delivery status
- Open rates
- Error logs

---

## üß© Understanding the Components

### Backend (FastAPI)

**FastAPI** is a modern Python web framework for building APIs. It's fast, easy to use, and automatically generates API documentation.

**Key files**:

1. **`main.py`**: The main application file
   - Defines API endpoints (routes)
   - Sets up scheduled tasks for email reminders
   - Handles CORS for frontend communication

2. **`database.py`**: Database connection
   - Creates SQLite database connection
   - Provides `get_db()` function for dependency injection

3. **`models.py`**: Database models (ORM)
   - Defines the structure of data in the database
   - `Drug` model represents a medicine with all its properties
   - Includes computed properties like `days_remaining`, `needs_reorder`

4. **`schemas.py`**: Pydantic schemas
   - Validates incoming data (requests)
   - Serializes outgoing data (responses)
   - Ensures data has the correct types and values

5. **`crud.py`**: Database operations
   - CRUD = Create, Read, Update, Delete
   - Contains all functions that interact with the database

6. **`email_service.py`**: Email functionality
   - Sends automated reminders
   - Uses `aiosmtplib` for async email sending

**Key Concepts**:

- **Dependency Injection**: `db: Session = Depends(get_db)` automatically provides database session
- **Async/Await**: Functions marked with `async` run asynchronously for better performance
- **Scheduled Jobs**: APScheduler runs tasks on a schedule (e.g., every Sunday at 9 AM)

### Frontend (Svelte)

**Svelte** is a modern frontend framework that compiles to vanilla JavaScript. Unlike React or Vue, Svelte does the heavy lifting at build time.

**Key files**:

1. **`App.svelte`**: Main component
   - Contains all UI logic and styling
   - Manages state (drugs list, forms, etc.)
   - Handles user interactions

2. **`api.js`**: API client
   - Functions to call backend endpoints
   - Uses axios for HTTP requests

**Key Svelte Concepts**:

- **Reactive Statements** (`$:`): Automatically re-run when dependencies change
- **Two-way Binding** (`bind:value`): Automatically sync input with variables
- **Conditional Rendering** (`{#if}...{/if}`): Show/hide elements
- **Loops** (`{#each}...{/each}`): Render lists
- **Event Handlers** (`on:click`): Respond to user actions

**Example**:
```svelte
<script>
  let count = 0;

  // This runs automatically when count changes
  $: doubled = count * 2;

  function increment() {
    count += 1;
  }
</script>

<button on:click={increment}>
  Count: {count}, Doubled: {doubled}
</button>
```

### Docker

**Docker** packages applications into containers - lightweight, standalone units that include everything needed to run.

**Benefits**:
- Same environment everywhere (dev, staging, production)
- Easy to deploy and scale
- Isolates dependencies

**Key files**:

1. **`Dockerfile`**: Instructions to build a Docker image
2. **`docker-compose.yml`**: Defines multiple containers and how they connect

---

## üîß API Endpoints

### Drugs

- `GET /drugs/` - Get all drugs
- `GET /drugs/{id}` - Get specific drug
- `POST /drugs/` - Create new drug
- `PUT /drugs/{id}` - Update drug
- `DELETE /drugs/{id}` - Delete drug
- `POST /drugs/{id}/refill` - Refill drug (add packages)

### Status

- `GET /drugs-status/reorder` - Get drugs needing reorder

### Reminders

- `POST /test-email` - Send test email
- `POST /send-weekly-reminder` - Manually trigger weekly reminder
- `POST /send-reorder-reminder` - Manually trigger reorder reminder

Full API documentation available at `/docs` when running the backend.

---

## üìù Usage Guide

### Adding a Drug

1. Click "Add New Drug"
2. Fill in:
   - **Name**: Medicine name (e.g., "Aspirin")
   - **Package Size**: Pills per package (e.g., 30)
   - **Pills per Dose**: How many pills per dose (e.g., 1)
   - **Times per Day**: How many doses daily (e.g., 2)
   - **Current Amount**: Pills currently available
   - **Quarterly**: Check if it requires insurance card quarterly
3. Click "Add Drug"

### Refilling

1. Click "Refill" on a drug card
2. Enter number of packages received
3. The system automatically calculates pills added

### Monitoring

- Dashboard shows remaining days/weeks for each drug
- Drugs with less than 3 weeks remaining are highlighted
- Warning banner appears when drugs need reordering

### Email Reminders

**Automatic** (configured schedule):
- Weekly reminder: Sunday 9:00 AM
- Reorder check: Daily 10:00 AM

**Manual** (click buttons in UI):
- Send Weekly Reminder
- Send Reorder Reminder
- Test Email

---

## üõ†Ô∏è Maintenance

### Database Persistence

The database is stored in a **Docker named volume** (`medicine-data`) which means:
- ‚úÖ Data persists when containers are stopped/restarted
- ‚úÖ Data persists when containers are rebuilt
- ‚úÖ Data is isolated from the container lifecycle

### Backup Database

**Using Docker volumes:**

```bash
# Create backup of the entire volume
docker run --rm -v medicine-data:/data -v $(pwd):/backup alpine tar czf /backup/medicine-db-backup.tar.gz -C /data .

# Restore from backup (if needed)
docker run --rm -v medicine-data:/data -v $(pwd):/backup alpine sh -c "cd /data && tar xzf /backup/medicine-db-backup.tar.gz"
```

**Manual database file backup:**

```bash
# Enter container and copy database
docker-compose exec backend cp /app/data/medicine.db /app/data/backup-$(date +%Y%m%d).db

# Download to local machine
docker cp medicine-tracker-backend:/app/data/medicine.db ./medicine-backup.db
```

### View Logs

```bash
# All logs
docker-compose logs -f

# Backend only
docker-compose logs -f backend

# Frontend only
docker-compose logs -f frontend
```

### Update Application

Just push to GitHub! CI/CD will handle deployment automatically.

Or manually on VPS:

```bash
cd ~/medicine-tracker
git pull origin main
docker-compose up -d --build
```

### Restart Services

```bash
docker-compose restart
```

---

## üêõ Troubleshooting

### Email not sending

1. **Check `.env` file has correct Mailjet credentials:**
   - `MAILJET_API_KEY` and `MAILJET_API_SECRET` are set
   - `FROM_EMAIL` is verified in Mailjet (Account Settings > Sender Addresses)
   - `TO_EMAIL` is set correctly

2. **Verify sender email in Mailjet:**
   - Go to [Mailjet Sender Addresses](https://app.mailjet.com/account/sender)
   - Make sure your `FROM_EMAIL` is listed and verified (green checkmark)

3. **Check Mailjet Dashboard:**
   - Go to [Mailjet Stats](https://app.mailjet.com/stats)
   - Check for any error messages or failed deliveries

4. **Use "Test Email" button** in the web interface to diagnose

5. **Check backend logs:**
   ```bash
   docker-compose logs backend
   ```
   Look for Mailjet error messages

6. **Common issues:**
   - Sender email not verified ‚Üí Verify it in Mailjet dashboard
   - Invalid API keys ‚Üí Regenerate keys in Mailjet
   - Daily sending limit reached (200/day on free tier)

### Can't access the app

1. Check containers are running: `docker-compose ps`
2. Check port 80 is not blocked by firewall:
   ```bash
   ufw allow 80
   ufw allow 443
   ```
3. Check logs for errors

### Database issues

**Migration errors:**

If you see "Target database is not up to date":
```bash
# In Docker
docker-compose exec backend alembic upgrade head

# Local development
cd backend
alembic upgrade head
```

**Schema issues:**

1. Check migration status: `alembic current`
2. Review migration history: `alembic history`
3. If corrupted, restore from backup

**Complete reset** (‚ö†Ô∏è WILL LOSE DATA):
```bash
# Stop containers and remove volume
docker-compose down -v

# Start fresh (migrations run automatically)
docker-compose up -d --build
```

üìö **For detailed migration troubleshooting, see:** `backend/MIGRATIONS.md`

---

## üìä Scheduled Reminders

The system automatically sends:

1. **Weekly Setup Reminder** (Sunday 9:00 AM):
   - Lists all drugs
   - Shows dosage for each
   - Displays remaining pills

2. **Reorder Reminder** (Daily 10:00 AM, only if needed):
   - Lists drugs with < 3 weeks remaining
   - Shows exact time remaining
   - Highlights quarterly drugs if it's a new quarter

3. **Quarterly Insurance Card Reminder**:
   - Automatically included in reorder emails
   - Only shows in January, April, July, October
   - Only for drugs marked as "Quarterly"

### Customizing Schedule

Edit `backend/app/main.py`:

```python
# Change weekly reminder time
scheduler.add_job(
    send_weekly_reminder_job,
    CronTrigger(day_of_week="sun", hour=9, minute=0),  # Sunday 9:00 AM
    id="weekly_reminder",
)

# Change reorder check time
scheduler.add_job(
    send_reorder_reminder_job,
    CronTrigger(hour=10, minute=0),  # Daily 10:00 AM
    id="reorder_reminder",
)
```

Cron trigger format:
- `day_of_week`: "mon", "tue", "wed", "thu", "fri", "sat", "sun"
- `hour`: 0-23 (24-hour format)
- `minute`: 0-59

---

## üîê Security Considerations

- Keep `.env` file private (never commit to Git)
- Use strong passwords
- Keep Docker and system updated:
  ```bash
  apt update && apt upgrade -y
  ```
- Consider adding authentication if exposing to internet
- Use HTTPS (SSL) with Let's Encrypt (covered in deployment guide)

---

## üìÑ License

This is a private project for personal use. Keep it simple and private!

---

## üÜò Support

If you encounter issues:

1. Check the troubleshooting section above
2. Review logs: `docker-compose logs`
3. Verify email configuration
4. Ensure all environment variables are set correctly

---

## üéØ Next Steps

After setup:

1. ‚úÖ Test email configuration
2. ‚úÖ Add all current medicines
3. ‚úÖ Set correct current amounts
4. ‚úÖ Test refill functionality
5. ‚úÖ Verify reminders are working (use manual triggers)
6. ‚úÖ Set up regular backups

Enjoy stress-free medicine management! üíä
